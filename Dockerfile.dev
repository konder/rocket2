# =============================================================================
# Dockerfile.dev - 开发镜像 (Apple Silicon Mac + x86 模拟)
# =============================================================================
# 所有大文件已在本机预下载，Docker 构建时只做 COPY + 安装，不下载大文件。
#
# 前置条件 (本机预下载):
#   rocket2/MineStudio/                                  ← MineStudio 源码 + SAM2 checkpoints
#   rocket2/simulator_engine/engine.zip                  ← Minecraft 模拟器引擎
#   rocket2/hf_models/                                   ← ROCKET-2 模型权重
#   rocket2/timm_models/                                 ← timm ViT 预训练权重
#
# 构建:
#   docker build --platform linux/amd64 -f Dockerfile.dev -t rocket2-dev .
#
# 运行:
#   docker run -it -p 7860:7860 --platform linux/amd64 rocket2-dev
# =============================================================================

ARG BASE_IMAGE=pytorch/pytorch:2.1.2-cuda12.1-cudnn8-devel
FROM ${BASE_IMAGE}

# 修复 x86 模拟下 OpenSSL AES-NI bug (QEMU/Rosetta 已知问题)
ENV OPENSSL_ia32cap="~0x200000200000000"

# apt 源换为阿里云 (HTTP, 无 SSL)
RUN sed -i "s|http://archive.ubuntu.com/ubuntu|http://mirrors.aliyun.com/ubuntu|g" /etc/apt/sources.list && \
    sed -i "s|http://security.ubuntu.com/ubuntu|http://mirrors.aliyun.com/ubuntu|g" /etc/apt/sources.list

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    wget git gnutls-bin openssh-client \
    libghc-x11-dev gcc-multilib g++-multilib \
    libglew-dev libosmesa6-dev libgl1-mesa-glx libglfw3 \
    xvfb mesa-utils libegl1-mesa libgl1-mesa-dev libglu1-mesa-dev \
    libglib2.0-0 libsm6 libxrender1 libxext6 \
    unzip openjdk-8-jdk \
    && rm -rf /var/lib/apt/lists/*

# pip 用阿里云 HTTP 镜像
ENV PIP_INDEX_URL=http://mirrors.aliyun.com/pypi/simple/
ENV PIP_TRUSTED_HOST=mirrors.aliyun.com
ENV PIP_RETRIES=5
ENV PIP_TIMEOUT=60

RUN python -m pip uninstall opencv -y && \
    python -m pip install --upgrade pip
RUN python -m pip install minestudio==1.1.2
RUN python -m pip install opencv-python==4.8.0.74 opencv-python-headless==4.8.0.74
RUN python -m pip install gradio==5.9.1 pillow==11.0.0

USER root
WORKDIR /app

# ---- COPY 本机预下载的文件 (不在 Docker 内下载) ----

# 1. MineStudio 源码 + SAM2 checkpoints
COPY MineStudio /app/MineStudio

# 2. 安装 SAM2 (CPU 模式: 删掉 CUDA 扩展，只装纯 Python)
RUN cd MineStudio/minestudio/utils/realtime_sam && \
    python -c "\
import re; \
s = open('setup.py').read(); \
s = s.replace('ext_modules=get_extensions(),', 'ext_modules=[],'); \
s = s.replace('cmdclass={\"build_ext\": BuildExtension.with_options(no_python_abi_suffix=True)},', 'cmdclass={},'); \
open('setup.py','w').write(s); \
print('setup.py patched for CPU-only build')" && \
    python -m pip install --no-build-isolation -e .

# SAM2 安装会升级 torch 依赖链，修复版本冲突:
# 1. numpy<2 兼容 opencv-python 4.8 和 gym
# 2. 升级 gradio 到修复了 gradio_client bug 的版本
RUN python -m pip install 'numpy<2' && \
    python -m pip install 'gradio>=5.12,<6' && \
    python -m pip install 'numpy<2'

# 3. 模拟器引擎
#    check_engine() 检查 {MINESTUDIO_DIR}/engine/build/libs/mcprec-6.13.jar
#    所以需要: 设置正确的 MINESTUDIO_DIR + 解压 engine.zip
ENV MINESTUDIO_DIR="/app/minestudio_dir"
RUN mkdir -p ${MINESTUDIO_DIR}
COPY simulator_engine/engine.zip ${MINESTUDIO_DIR}/engine.zip
RUN cd ${MINESTUDIO_DIR} && unzip -o engine.zip && rm -f engine.zip

# 4. ROCKET-2 本地源码
COPY . /app/ROCKET-2/
WORKDIR /app/ROCKET-2

# 5. 模型权重 (从 hf_models/ 目录 COPY 进来)
COPY hf_models /root/.cache/huggingface/hub

# 模型权重已通过 hf_models COPY 进缓存
ARG HF_ENDPOINT="https://hf-mirror.com"
ENV HF_ENDPOINT=${HF_ENDPOINT}

# 6. timm ViT 预训练权重 (本机已预下载, 直接 COPY 到固定路径)
#    model.py 中 _create_model_with_retry() 会优先从 TIMM_LOCAL_WEIGHTS 目录加载
#    目录结构: /app/timm_weights/{model_short_name}/model.safetensors
ENV TIMM_LOCAL_WEIGHTS="/app/timm_weights"
COPY timm_models/vit_base_patch16_224.dino ${TIMM_LOCAL_WEIGHTS}/vit_base_patch16_224.dino/
COPY timm_models/vit_tiny_patch16_224.augreg_in21k_ft_in1k ${TIMM_LOCAL_WEIGHTS}/vit_tiny_patch16_224.augreg_in21k_ft_in1k/

# 开发环境默认 CPU
ENV ROCKET_DEVICE="cpu"
ENV CUDA_VISIBLE_DEVICES=""

CMD ["python", "launch.py", "--env-conf", "./env_conf", "--sam-path", "/app/MineStudio/minestudio/utils/realtime_sam/checkpoints"]

# =============================================================================
# docker-compose.yml
# =============================================================================
# 开发 (Mac):  docker compose --profile dev up --build
# 生产 (服务器): docker compose --profile server up --build
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # 开发环境 - Apple Silicon Mac (x86 模拟 + CPU)
  # ---------------------------------------------------------------------------
  dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        # 拉不到 nvcr.io 时，可换成:
        # BASE_IMAGE: pytorch/pytorch:2.1.2-cuda12.1-cudnn8-devel
        BASE_IMAGE: nvcr.io/nvidia/pytorch:24.01-py3
    platform: linux/amd64
    image: rocket2-dev:latest
    ports:
      - "7860:7860"
    environment:
      - ROCKET_DEVICE=cpu
      - CUDA_VISIBLE_DEVICES=
    volumes:
      # 挂载本地源码，支持热更新开发 (覆盖容器内 /app/ROCKET-2)
      - ./launch.py:/app/ROCKET-2/launch.py
      - ./model.py:/app/ROCKET-2/model.py
      - ./cfg_wrapper.py:/app/ROCKET-2/cfg_wrapper.py
      - ./draw_action.py:/app/ROCKET-2/draw_action.py
      - ./train.py:/app/ROCKET-2/train.py
      - ./cross_view_dataset.py:/app/ROCKET-2/cross_view_dataset.py
      - ./config.yaml:/app/ROCKET-2/config.yaml
      - ./config_xl.yaml:/app/ROCKET-2/config_xl.yaml
      - ./env_conf:/app/ROCKET-2/env_conf
      - ./gallery:/app/ROCKET-2/gallery
      - ./keyboard-assets:/app/ROCKET-2/keyboard-assets
      - ./theme.json:/app/ROCKET-2/theme.json

  # ---------------------------------------------------------------------------
  # 生产环境 - Linux 服务器 (NVIDIA GPU)
  # ---------------------------------------------------------------------------
  server:
    profiles: ["server"]
    build:
      context: .
      dockerfile: Dockerfile
    image: rocket2:latest
    ports:
      - "7860:7860"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
